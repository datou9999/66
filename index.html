<!-- ... 你上面HTML和CSS不变 ... -->

<script src="/js/adapter-latest.js"></script>
<script src="/js/jssip.min.js"></script>

<script>
  // 你原来的拨号盘代码
  function appendNumber(num) {
    const input = document.getElementById("numberInput");
    input.value += num;
  }
  function deleteNumber() {
    const input = document.getElementById("numberInput");
    input.value = input.value.slice(0, -1);
  }

  // SIP 相关变量
  let ua = null;
  let session = null;
  let localStream = null;
  let isCalling = false;

  // SIP 注册和连接函数
  function startUA() {
    if (ua) return;

    const socket = new JsSIP.WebSocketInterface('wss://123.xin.anjre.cn:8089/ws');
    const configuration = {
      sockets: [socket],
      uri: 'sip:1001@123.xin.anjre.cn',
      password: 'Aa6363463@',
      display_name: '网页客户',
      session_timers: false,
      register: true
    };

    ua = new JsSIP.UA(configuration);

    ua.on('registered', () => {
      console.log('✅ 注册成功');
    });

    ua.on('registrationFailed', e => {
      alert('注册失败，请刷新页面重试');
      resetUI();
    });

    ua.on('newRTCSession', e => {
      session = e.session;
      session.on('progress', () => updateStatus("振铃中..."));
      session.on('accepted', () => {
        updateStatus("通话中");
      });
      session.on('ended', () => {
        updateStatus("通话结束");
        resetUI();
      });
      session.on('failed', () => {
        updateStatus("通话失败");
        resetUI();
      });
    });

    ua.start();
  }

  // 状态更新
  function updateStatus(text) {
    // 你可以用页面上的某个元素显示状态，比如添加一个div显示状态
    console.log(text);
  }

  // 发起呼叫
  async function makeCall() {
    if (isCalling) return;
    const number = document.getElementById("numberInput").value;
    if (!number) {
      alert("请输入客服编号");
      return;
    }

    try {
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    } catch (e) {
      alert('请允许使用麦克风，否则无法呼叫客服');
      return;
    }

    startUA();

    // 延迟等UA启动
    setTimeout(() => {
      if (!ua) {
        alert('SIP尚未准备好');
        return;
      }
      isCalling = true;
      session = ua.call('sip:' + number + '@123.xin.anjre.cn', {
        mediaConstraints: { audio: true, video: false },
        mediaStream: localStream,
      });
      updateStatus('拨号中...');
    }, 1000);
  }

  // 挂断
  function hangupCall() {
    if (session) session.terminate();
    resetUI();
  }

  // 重置UI和状态
  function resetUI() {
    isCalling = false;
    if (localStream) {
      localStream.getTracks().forEach(t => t.stop());
      localStream = null;
    }
    session = null;
    updateStatus('等待操作');
  }

  // 绑定呼叫按钮
  document.querySelector('.button-call').onclick = makeCall;

</script>
